apiVersion: v1
kind: ConfigMap
metadata:
  name: modsecurity-config
data:
  # https://github.com/coreruleset/coreruleset/blob/main/crs-setup.conf.example#L462-L470
  custom-base-config.conf: |
    # HTTP methods that a client is allowed to use.
    # Default: GET HEAD POST OPTIONS
    # Example: for RESTful APIs, add the following methods: PUT PATCH DELETE
    # Example: for WebDAV, add the following methods: CHECKOUT COPY DELETE LOCK
    #          MERGE MKACTIVITY MKCOL MOVE PROPFIND PROPPATCH PUT UNLOCK
    # Uncomment this rule to change the default.
    #
    # The HTTP PUT method is normally used to upload data that is saved on the server at a user-supplied URL.
    # If enabled, an attacker may be able to inject arbitrary, and potentially malicious, content into the application or on to the file system of the web server.
    # Depending on the server's configuration, this may lead to compromise of other users (by uploading
    # client-executable scripts), compromise of the server (by uploading server-executable code), or other attacks.
    # For this reason, the PUT method is disabled by default.
    # GET, HEAD, POST and OPTIONS are seen as the minimal set of HTTP methods
    # from a security perspective. For static sites, removing the POST is
    # recommended. Add other HTTP methods as seen fit (see above).
    #
    SecAction \
        "id:900200,\
        phase:1,\
        pass,\
        t:none,\
        nolog,\
        tag:'OWASP_CRS',\
        ver:'OWASP_CRS/4.22.0-dev',\
        setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE'"

  custom-nextcloud-config.conf: |
    # Generic rule to disable the plugin
    #
    # Plugins are enabled by default.
    #
    # They become active by placing them in the plugin folder. It is possible to
    # control plugin activation via setting a variable. This can be done in the
    # plugin config file here.
    #
    # The predefined variable name is meant to be "<plugin name>-plugin_enabled".
    # For the nextcloud-rule-exclusions-plugin, this means it can be disabled by setting
    # tx.nextcloud-rule-exclusions-plugin_enabled=0.
    #
    # Note that a global setting of this variable overrides the setting here.
    # That means the "enabled" variable is only set by this rule if it has not
    # been set before.
    #
    # Feel free to set the variable unconditionally here by replacing the
    # SecRule line with an unconditional SecAction statement.
    #
    # SecRule &TX:nextcloud-rule-exclusions-plugin_enabled "@eq 0" \
    #     "id:9508010,\
    #     phase:1,\
    #     pass,\
    #     nolog,\
    #     ver:'nextcloud-rule-exclusions-plugin/1.5.0',\
    #     setvar:'tx.nextcloud-rule-exclusions-plugin_enabled=0'"
    
    # https://help.nextcloud.com/t/modsecurity-apache-nextcloud/83987/9
    # https://coreruleset.org/docs/4-about-plugins/4-1-plugins/#conditionally-enable-plugins-for-multi-application-environments
    
    SecRule &TX:nextcloud-rule-exclusions-plugin_enabled "@eq 0" \
         "id:9508010,\
         phase:1,\
         pass,\
         nolog,\
         ver:'nextcloud-rule-exclusions-plugin/1.5.0',\
         chain"
         SecRule REQUEST_HEADERS:Host "!@streq cloud.felix-prasse.de" \
            "t:none,\
            setvar:'tx.nextcloud-rule-exclusions-plugin_enabled=0'"
    
    # Crowdsec uses Coraza: https://github.com/coreruleset/nextcloud-rule-exclusions-plugin?tab=readme-ov-file#coraza-default-body-processor
    SecRule REQBODY_PROCESSOR "!@rx (?:URLENCODED|MULTIPART|XML|JSON)" \
      "id:9508033,\
      phase:1,\
      pass,\
      nolog,\
      ctl:requestBodyProcessor=RAW"
