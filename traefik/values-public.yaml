traefik:
  # Configure Network Ports and EntryPoints
  # EntryPoints are the network listeners for incoming traffic.
  ports:
    # Defines the HTTP entry point named 'web'
    web:
      port: 80
      #nodePort: 30000
      # Instructs this entry point to redirect all traffic to the 'websecure' entry point
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

    # Defines the HTTPS entry point named 'websecure'
    websecure:
      port: 443
      #nodePort: 30001
      middlewares:
        - traefik-bouncer@kubernetescrd
        - traefik-public-hsts-header@kubernetescrd

  # Enables the dashboard in Secure Mode
  api:
    dashboard: true
    insecure: false

  ingressRoute:
    dashboard:
      enabled: true
      annotations:
         kubernetes.io/ingress.class: traefik-public
      labels:
        traefik.io/controller: public
      matchRule: Host(`public.traefik.home.arpa`)
      entryPoints:
        - websecure
      middlewares:
        - name: dashboard-public-auth

  # Creates a BasiAuth Middleware and Secret for the Dashboard Security
  extraObjects:
    - apiVersion: bitnami.com/v1alpha1
      kind: SealedSecret
      metadata:
        creationTimestamp: null
        name: crowdsec-lapi
        namespace: traefik
      spec:
        encryptedData:
          # TODO This must be kept in sync with crowdsec secret. So either use openbao or kubernetes-reflector
          traefik: AgA1Gsavg89i+pISZFYyEdXel3v0OL8D0c4E0q0OYRAsFUJ54MMzSJnd4myrSb0l2o3/1OhH/kwY8431wXwLxIje+y5kG39IvIVoVTc7Rz43UwtbdUy0QMnSLONmpMZCSmssxfXTkMs7h0sbYsUZ+V6jbdMQsCb7qF+4lO5/dtInEIHe2kQ+rMLyv6cU3eVld7SE7d9KkIzyEBao3R9qdjzjyNZFsX8CkXIW5TnACrY9KDzNJVyX7XQ7zfTo1WlsmRF6bmtARKoWqTMaa95J69NH5jHHgpr8i+jFhCFl//FXrrGTOfJ80qad6VMuvJPGgKcL/vumEOxYqfAnMUKkLkEG5IBE+F5N4b2SE0EOfC40raMquF3EmZXCY6LQhY6eUTO14oA9WJuXabZCy1K0PQcCmpVSDyilxC+jUK+a93XnrC9mQZyAmuXD0t0fCaPN95D4cPVeKK9WexISH+nv1re9B775q386FR7nC4jf7wqSyp2JFS6zhTuD8cJdVmuFpKDyQzMVaim2QXjpRMPd7fAY/9jaCWoZKBv+t2LPBu+H9TsZKr2qpylHuyWDrDOpdRgGEM+TQ71pSw0Rxg4wNj1NR28YB7trN1FgbCksCJFWiP5v/Hb4gCHs5MMdHhCjM0G+aGIMF99tpaYJMA1tOb7E7LV76ZFQ1WFvF6hF80EGD3cXG9Ans2lSuBuRCCARahYYIHZlH+TzkKAOwCGVGYsq
        template:
          metadata:
            creationTimestamp: null
            name: crowdsec-lapi
            namespace: traefik
    - apiVersion: bitnami.com/v1alpha1
      kind: SealedSecret
      metadata:
        creationTimestamp: null
        name: dashboard-public-auth-secret
        namespace: traefik
      spec:
        encryptedData:
          password: AgAt5E/hJrPEIgrWwWRcYkM2qdX62U+0f/6mQhKvqLkkzbGX/9R95j9ywl2akV+3iYAjE8AGcqhUBg4gss9FWct669nS7IBihTrWCkjyUGubkFABYolVIuiRvpIgSoppaa1IuDB4/n0JqCY8XRDQe5KF9CXqxcdA86wsAzV7ykUajSpcPE1Kq/m6O5RQapba34Y7f+w2APOOfFBCPcv+MPwfcicpCibkzuIBl8F2hgEMZHrz/09ygjieIwdMMbQONfCCPrR/oCpZdZNeUJu8VkV7Qwbu1l1Xf5OaVsBTmMcS1uPAQtaNYsggWKicgYdQKNg7LuTtBcDbpMqPUFYJplYlAJhjGkypD2nI7f55FtMEm7d1PSG3xjXL91+fh7X+V9Bfw94LGB8pCpXrgLGqtIp5ATfggdtiPj/BxHzEsMnjhGcyd2Wc4H4WSJ3s1pHLrj7hSSHCxAJUPK7Br7pgFCk9uCdP0962e5QZ7iyioSxHZ+b4UUhaU8cdGGB59wAPd+PBkXikaOjLSHVXL4JygwdlcfA51ClpMU2UbL/VjZddbdkH7A8qPzvdZ5XDDa9Qy+xFp8ipvQy734EI9JnyfMBfTGgW2Kmgz4CcVpp+urCg7MSm5+opeBif13td5gE1hO8e+X71ykCmOeLNsl8c+LO3JYqsv35gIK05EX3ERewSQwgBo1evCBcwVJNNfS8LNIPdNIAbpbKbGfum+E0hiLEv
          username: AgChuCROfoOiLQZc7Ec3+jHZwrnj2ZkPcWb1S32sHK7hTy1Kulg9xoDNOnOkp20+b56AsVWYzHobZHPVh9F0M63Rqril4+OpkHOE4Cc9hpKOzOPcel44e8zZydMTWTcNIbBlz1fD2CWbkrqEzjuHmWS12OwtLVMIJ5NC8sJY6ec8XvWXXVLvF/uVEs0DOv1wfEGUJobaDyhzoDNKlDcGhPS5RkPtIDxzrYLkIw7m0z+ykV04bqjhBpdZFN2mD0cs6+Y/aaIgjPjs7hQt3lZ9v18FbJm5/TnZKDpGmBpqJv7aAnE0bUijwcslrGcck802cvKYfRKmiQYMlWjTf0fwl78+OqC4UkZEr1/+HNk8bOtSyEK4twKPWyv9MFRJ5lRgsajxqtJqO0SRTnaUMa37OLw1TZP/YulimiueFHxfl9e5kbb8IkcCSamHyahcH6U/eOaBMiOuJI38BWFRs03LEIucl+UtvD12+6EOPvHeax30VpDg7Q0aojKJ03VX46mWxH2BwD6OJr1TwSfW7bCKZ+FXxWIHJ9dQ9TvWMlAw5z1JffoOsoxr0FrvbFUWpzFv/1nWaUMXahypE+ervxu0nIt+ulACwBFDPxb7KcYGekKYEpDYNSlAeMRnzqzETQW+C4MDbMlJ06ky3sWf80x7mkT82ph8af02PaJdMKK3Q0jeDMjRs6BHoIbtZBJwQ2PWjs9OMliFzA==
        template:
          metadata:
            creationTimestamp: null
            name: dashboard-public-auth-secret
            namespace: traefik
          type: kubernetes.io/basic-auth
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: dashboard-public-auth
        labels:
          traefik.io/controller: public
      spec:
        basicAuth:
          secret: dashboard-public-auth-secret
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: bouncer
        namespace: traefik
        labels:
          traefik.io/controller: public
      spec:
        plugin:
          crowdsec-bouncer-traefik-plugin:
            enabled: true
            crowdsecMode: stream
            crowdsecLapiScheme: http
            crowdsecLapiHost: crowdsec-service.crowdsec.svc.cluster.local:8080
            crowdsecLapiKeyFile: /crowdsec/traefik
            crowdsecAppsecEnabled: true
            crowdsecAppsecHost: crowdsec-appsec-service.crowdsec.svc.cluster.local:7422
            crowdsecAppsecPath: "/"
            crowdsecAppsecFailureBlock: true
            crowdsecAppsecUnreachableBlock: true
            crowdsecAppsecBodyLimit: 10485760
            crowdsecLapiPath: "/"
            banHTMLFilePath: "/pages/ban.html"
    - apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: public-hsts-header
        namespace: traefik
        labels:
          traefik.io/controller: public
      spec:
        headers:
          stsSeconds: 15552000

  volumes:
   - name: crowdsec-lapi
     mountPath: "/crowdsec"
     type: secret
   - name: traefik-public-custom-html
     mountPath: "/pages"
     type: configMap

  service:
    annotations:
      external-dns.alpha.kubernetes.io/hostname: public.traefik.home.arpa # TODO This is just a hack to notify external-dns of the route crd....
      kube-vip.io/loadbalancerIPs: 192.168.2.96

    spec:
      externalTrafficPolicy: Local

  # We will route with Gateway API instead.
  ingressClass:
    enabled: true
    isDefaultClass: false
    name: traefik-public

  # Enable Gateway API Provider & Disables the KubernetesIngress provider
  # Providers tell Traefik where to find routing configuration.
  providers:
    kubernetesCRD:
      ingressClass: traefik-public
      labelSelector: traefik.io/controller=public
    kubernetesIngress:
      enabled: true
      ingressClass: traefik-public
    kubernetesGateway:
      enabled: false

  ## Gateway Listeners
  #gateway:
  #  listeners:
  #    web:           # HTTP listener that matches entryPoint `web`
  #      port: 80
  #      protocol: HTTP
  #      namespacePolicy:
  #        from: All
  #
  #    websecure:         # HTTPS listener that matches entryPoint `websecure`
  #      port: 443
  #      protocol: HTTPS  # TLS terminates inside Traefik
  #      namespacePolicy:
  #        from: All
  #      mode: Terminate
  #      certificateRefs:
  #        - kind: Secret
  #          name: local-selfsigned-tls  # the Secret we created before the installation
  #          group: ""

  # Enable Observability
  logs:
    general:
      level: INFO
    # This enables access logs, outputting them to Traefik's standard output by default. The [Access Logs Documentation](https://doc.traefik.io/traefik/observability/access-logs/) covers formatting, filtering, and output options.
    access:
      enabled: true

  # Enables Prometheus for Metrics
  metrics:
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true

  experimental:
    plugins:
      crowdsec-bouncer-traefik-plugin:
        moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
        version: "v1.4.5"